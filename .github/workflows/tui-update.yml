# This workflow will do a clean install of node dependencies, build the source code and run tests across different versions of node
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-nodejs-with-github-actions

name: Update TUI versions
# on:
#   schedule:
#     # * is a special character in YAML so you have to quote this string
#     # Every Monday at 1PM UTC (9AM EST)
#     # first - minutes
#     # second - hours
#     # the last * - is day of the week (0 - 6 or SUN-SAT) text
#     - cron:  '10,50 * * * 3'

# temporary
on:
  push:
    branches: [ master ]

jobs:
  update-deps:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v1
        with:
          node-version: '14.x'

      - name: Set ID value
        # -u "${{ secrets.JIRA_USER }}:${{ secrets.JIRA_PASSWORD }}"
        run: |
          echo 'JIRA_ID<<EOF' >> $GITHUB_ENV

          curl -X POST \
          -H "Content-Type: application/json; charset=UTF-8" \
          -d '{"title": "linuxize", "body": "${{ secrets.JIRA_USER }}", "userId": 1}' \
          https://jsonplaceholder.typicode.com/posts \
          | jq '.id' >> $GITHUB_ENV

          echo 'EOF' >> $GITHUB_ENV

      - name: Update dependencies
        run: |
            echo "//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}" >> ~/.npmrc
            npx npm-check-updates "/@talend\/.*/" -u
            yarn
            npx yarn-deduplicate yarn.lock
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v3
        with:
            branch: update-dependencies
            committer: GitHub <inna-i@github.com>
            title: "feat(ID-${{env.JIRA_ID}}): update packages"
            body: |
              Update packages
              - packages.json is changed
              - yarn.lock updated and depuplicated
              - Auto-generated by [create-pull-request][1]

              [1]: https://github.com/peter-evans/create-pull-request
            reviewers: inna-i

      - name: Check outputs
        run: |
          echo "Pull Request Number - ${{ steps.cpr.outputs.pull-request-number }}"
          echo "Pull Request URL - ${{ steps.cpr.outputs.pull-request-url }}"
